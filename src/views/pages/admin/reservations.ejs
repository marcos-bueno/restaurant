<!DOCTYPE html>
<html>
   <head>
      <%- include('../../partials/admin/head') %>
   </head>
   <body class="hold-transition skin-blue sidebar-mini">
      <div class="wrapper">
         <!-- Header -->
         <header class="main-header">
            <%- include('../../partials/admin/header') %>
         </header>
         <!-- Sidebar  -->
         <aside class="main-sidebar">
            <%- include('../../partials/admin/sidebar') %>
         </aside>
         <!-- Content Wrapper -->
         <div class="content-wrapper">
            <section class="content-header">
               <h1>
                  Reservas
               </h1>
               <ol class="breadcrumb">
                  <li><a href="/dashboard"><i class="fa fa-home"></i> Início</a></li>
                  <li class="active">Reservas</li>
               </ol>
            </section>
            <section class="content container-fluid">
               <%- include('../../partials/flash') %>
               <div class="box">
                  <div class="box-header">
                     <h3 class="box-title">Lista</h3>
                     <a href="#" class="btn btn-xs pull-right btn-success" data-toggle="modal" data-target="#modal-create"><i
                        class="fa fa-plus"></i>
                     Novo</a>
                  </div>
                  <div class="box-body no-padding">
                     <table class="table table-striped table-hover">
                        <thead>
                           <tr>
                              <th style="width: 10px">#</th>
                              <th>Nome</th>
                              <th>E-mail</th>
                              <th>Qtde. Pessoas</th>
                              <th>Data</th>
                              <th>Hora</th>
                              <th style="min-width: 134px;">Ações</th>
                           </tr>
                        </thead>
                        <tbody>
                           <% data.forEach(row => { %>
                           <tr data-row="<%= JSON.stringify(row) %>">
                              <td><%= row.id %></td>
                              <td><%= row.name %></td>
                              <td><%= row.email %></td>
                              <td><%= row.people %></td>
                              <td><%= moment(row.date).format("DD [de] MMMM [de] YYYY") %></td>
                              <td><%= row.time %></td>
                              <td><button type="button" class="btn btn-xs btn-info btn-update"><i
                                 class="fa fa-pencil"></i> Editar</button>&nbsp;<button type="button" class="btn btn-xs btn-danger btn-delete"><i
                                 class="fa fa-trash"></i> Excluir</button></td>
                           </tr>
                           <% }); %>
                        </tbody>
                     </table>
                  </div>
               </div>
            </section>
         </div>
         <div class="modal fade" id="modal-create">
            <div class="modal-dialog">
               <div class="modal-content" style="border-top: 3px solid #00a65a;">
                  <form method="post">
                     <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">Nova Reserva</h4>
                     </div>
                     <div class="modal-body">
                        <div class="form-group">
                           <label for="inputNameCreate">Nome</label>
                           <input type="text" class="form-control" id="inputNameCreate" name="name">
                        </div>
                        <div class="form-group">
                           <label for="inputEmailCreate">E-mail</label>
                           <input type="email" class="form-control" id="inputEmailCreate" name="email">
                        </div>
                        <div class="form-group">
                           <label for="inputPeopleCreate">Pessoas</label>
                           <select id="inputPeopleCreate" name="people" class="form-control">
                              <option value=""> -- selecione -- </option>
                              <option value="1">1</option>
                              <option value="2">2</option>
                              <option value="3">3</option>
                              <option value="4">4</option>
                              <option value="5">5+</option>
                           </select>
                        </div>
                        <div class="form-group">
                           <label for="inputDateCreate">Data</label>
                           <input type="date" id="inputDateCreate" name="date" class="form-control">
                        </div>
                        <div class="form-group">
                           <label for="inputTimeCreate">Hora</label>
                           <input type="time" id="inputTimeCreate" name="time" class="form-control">
                        </div>
                     </div>
                     <div class="modal-footer">
                        <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Cancelar</button>
                        <button type="submit" id="createBtn" class="btn btn-success">Cadastrar</button>
                     </div>
                  </form>
               </div>
            </div>
         </div>
         <div class="modal fade" id="modal-update">
            <div class="modal-dialog">
               <div class="modal-content" style="border-top: 3px solid #00c0ef;">
                  <form method="post">
                     <input type="hidden" name="id">
                     <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">Editar Reserva</h4>
                     </div>
                     <div class="modal-body">
                        <div class="form-group">
                           <label for="inputNameUpdate">Nome</label>
                           <input type="text" class="form-control" id="inputNameUpdate" name="name">
                        </div>
                        <div class="form-group">
                           <label for="inputEmailUpdate">E-mail</label>
                           <input type="email" class="form-control" id="inputEmailUpdate" name="email">
                        </div>
                        <div class="form-group">
                           <label for="inputPeopleUpdate">Qtde. Pessoas</label>
                           <select id="inputPeopleUpdate" name="people" class="form-control">
                              <option value=""> -- selecione -- </option>
                              <option value="1">1</option>
                              <option value="2">2</option>
                              <option value="3">3</option>
                              <option value="4">4</option>
                              <option value="5">5+</option>
                           </select>
                        </div>
                        <div class="form-group">
                           <label for="inputDateUpdate">Data</label>
                           <input type="date" id="inputDateUpdate" name="date" class="form-control">
                        </div>
                        <div class="form-group">
                           <label for="inputTimeUpdate">Hora</label>
                           <input type="time" id="inputTimeUpdate" name="time" class="form-control">
                        </div>
                     </div>
                     <div class="modal-footer">
                        <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Cancelar</button>
                        <button type="submit" id="updateBtn" class="btn btn-info">Atualizar</button>
                     </div>
                  </form>
               </div>
            </div>
         </div>
         <!-- Footer -->
         <footer class="main-footer">
            <%- include('../../partials/admin/footer') %>
         </footer>
      </div>
      <!-- Scripts -->
      <%- include('../../partials/admin/scripts') %>
      <!-- Page scripts -->
      <script src="../../js/moment.min.js"></script>
      <script>
         
         /* Create */

         const formCreate = document.querySelector("#modal-create form");

         const createBtn = document.querySelector("#createBtn");

         createBtn.addEventListener('click', async event => {

            const formCreateData = new FormData(formCreate);

            const object = {};

            formCreateData.forEach((value, key) => {
               object[key] = value
            });

            if(request.body.id === undefined) {
               await fetch(`/dashboard/reservas`, {
                  method: 'POST',
                  headers: { 
                     'Content-Type': 'application/json' 
                  },
                  body: JSON.stringify({
                     name: object.name,
                     email: object.email,
                     people: object.people,
                     date: object.date,
                     time: object.time,
                  }),
               });
               window.location.reload();
            }
         });

         /* Update */
         
         const formUpdate = document.querySelector("#modal-update form");

         [...document.querySelectorAll('.btn-update')].forEach(btn => {
         
           btn.addEventListener('click', async event => {
         
            var path = event.path || (event.composedPath && event.composedPath());
         
            let tr = path.find(element => {
         
               return (element.tagName.toUpperCase() === 'TR');
             });
         
             let data = JSON.parse(tr.dataset.row);
         
             for (let name in data) {
         
               let input = formUpdate.querySelector(`[name=${name}]`);
         
               switch (name) {
                 
                 case 'date':
         
                   if (input) input.value = moment(data[name]).format('YYYY-MM-DD');
                   break;
         
                 default:
         
                   if (input) input.value = data[name];
               }
             }
             $('#modal-update').modal('show');
           });
         });

         const updateBtn = document.querySelector("#updateBtn");

         updateBtn.addEventListener('click', async event => {
            event.preventDefault();
            const formData = new FormData(formUpdate);

            const object = {};

            formData.forEach((value, key) => {
               object[key] = value
            });

            await fetch(`/dashboard/reservas/${object.id}`, {
               method: 'PUT',
               headers: { 
                  'Content-Type': 'application/json' 
               },
               body: JSON.stringify({
                  id: object.id,
                  name: object.name,
                  email: object.email,
                  people: object.people,
                  date: object.date,
                  time: object.time,
               })
            })
            .then(response => {
               if(!object.name || !object.email || !object.people || !object.date || !object.time) {
                  throw new Error('Você deve preencher todos os campos!');
               }
               window.location.reload();
            })
            .catch(error => {
               alert(error.message);
            });
         });

         /* Delete */

         [...document.querySelectorAll('.btn-delete')].forEach(btn => {

            btn.addEventListener('click', async event => {

               event.preventDefault();

               var path = event.path || (event.composedPath && event.composedPath());
         
               let tr = path.find(element => {

                  return (element.tagName.toUpperCase() === 'TR');
               });

               let data = JSON.parse(tr.dataset.row);

               if (confirm(`Deseja realmente excluir a reserva de ${data.name}?`)) {

                  await fetch(`/dashboard/reservas/${data.id}`, {
                     method: 'DELETE'
                  });
               }
               window.location.reload();
            });
         });
      </script>
   </body>
</html>