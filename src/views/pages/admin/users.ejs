<!DOCTYPE html>
<html>
   <head>
      <%- include('../../partials/admin/head') %>
   </head>
   <body class="hold-transition skin-blue sidebar-mini">
      <div class="wrapper">
         <!-- Header -->
         <header class="main-header">
            <%- include('../../partials/admin/header') %>
         </header>
         <!-- Sidebar  -->
         <aside class="main-sidebar">
            <%- include('../../partials/admin/sidebar') %>
         </aside>
         <!-- Content Wrapper -->
         <div class="content-wrapper">
            <!-- Content Header (Page header) -->
            <section class="content-header">
               <h1>
                  Usuários
               </h1>
               <ol class="breadcrumb">
                  <li><a href="/"><i class="fa fa-home"></i> Home</a></li>
                  <li class="active">Usuários</li>
               </ol>
            </section>
            <!-- Main content -->
            <section class="content container-fluid">
               <%- include('../../partials/flash') %>
               <div class="box">
                  <div class="box-header">
                     <h3 class="box-title">Lista</h3>
                     <a href="#" class="btn btn-xs pull-right btn-success" data-toggle="modal" data-target="#modal-create"><i class="fa fa-plus"></i> Novo</a>
                  </div>
                  <!-- /.box-header -->
                  <div class="box-body no-padding">
                     <table class="table table-striped table-hover">
                        <thead>
                           <tr>
                              <th style="width: 10px">#</th>
                              <th>Nome</th>
                              <th>E-mail</th>
                              <th style="min-width: 134px;">Ações</th>
                           </tr>
                        </thead>
                        <tbody>
                           <% data.forEach(row => { %>
                           <tr data-row="<%= JSON.stringify(row) %>">
                              <td><%= row.id %></td>
                              <td><%= row.name %></td>
                              <td><%= row.email %></td>
                              <td>
                                 <button type="button" class="btn btn-xs btn-info"><i class="fa fa-pencil"></i> Editar</button>&nbsp;
                                 <button type="button" class="btn btn-xs btn-warning btn-update"><i class="fa fa-lock"></i> Alterar Senha</button>&nbsp;
                                 <button type="button" class="btn btn-xs btn-danger btn-delete"><i class="fa fa-trash"></i> Excluir</button>
                              </td>
                           </tr>
                           <% }); %>
                        </tbody>
                     </table>
                  </div>
                  <!-- /.box-body -->
               </div>
            </section>
            <!-- /.content -->
         </div>
         <div class="modal fade" id="modal-update-password">
            <div class="modal-dialog">
               <div class="modal-content" style="border-top: 3px solid #f39c12;">
                  <form method="post">
                     <input type="hidden" name="id">
                     <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">Alterar Senha</h4>
                     </div>
                     <div class="modal-body">
                        <div class="form-group">
                           <label for="inputPassword">Nova Senha</label>
                           <input type="password" class="form-control" id="inputPassword" name="newPassword">
                        </div>
                        <div class="form-group">
                           <label for="inputPasswordConfirm">Confirmar Senha</label>
                           <input type="password" class="form-control" id="inputPasswordConfirm" name="passwordConfirm">
                        </div>
                     </div>
                     <div class="modal-footer">
                        <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Cancelar</button>
                        <button type="submit" id="btnUpdatePassword" class="btn btn-warning">Atualizar</button>
                     </div>
                  </form>
               </div>
               <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
         </div>
         <div class="modal fade" id="modal-create">
            <div class="modal-dialog">
               <div class="modal-content" style="border-top: 3px solid #00a65a;">
                  <form method="post">
                     <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">Novo Usuário</h4>
                     </div>
                     <div class="modal-body">
                        <div class="form-group">
                           <label for="inputNameCreate">Nome</label>
                           <input type="text" class="form-control" id="inputNameCreate" name="name">
                        </div>
                        <div class="form-group">
                           <label for="inputEmailCreate">E-mail</label>
                           <input type="email" class="form-control" id="inputEmailCreate" name="email">
                        </div>
                        <div class="form-group">
                           <label for="inputPasswordCreate">Senha</label>
                           <input type="password" class="form-control" id="inputPasswordCreate" name="password">
                        </div>
                     </div>
                     <div class="modal-footer">
                        <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Cancelar</button>
                        <button type="submit" id="createBtn" class="btn btn-success">Cadastrar</button>
                     </div>
                  </form>
               </div>
               <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
         </div>
         <div class="modal fade" id="modal-update">
            <div class="modal-dialog">
               <div class="modal-content" style="border-top: 3px solid #00c0ef;">
                  <form method="post">
                     <input type="hidden" name="id">
                     <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">Editar Usuário</h4>
                     </div>
                     <div class="modal-body">
                        <div class="form-group">
                           <label for="inputNameUpdate">Nome</label>
                           <input type="text" class="form-control" id="inputNameUpdate" name="name">
                        </div>
                        <div class="form-group">
                           <label for="inputEmailUpdate">E-mail</label>
                           <input type="email" class="form-control" id="inputEmailUpdate" name="email">
                        </div>
                     </div>
                     <div class="modal-footer">
                        <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Cancelar</button>
                        <button type="submit" id="btnUpdateData" class="btn btn-info">Atualizar</button>
                     </div>
                  </form>
               </div>
               <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
         </div>
         <!-- Footer -->
         <footer class="main-footer">
            <%- include('../../partials/admin/footer') %>
         </footer>
      </div>
      <!-- Scripts -->
      <%- include('../../partials/admin/scripts') %>
      <!-- Page scripts -->
      <script type="text/javascript">

         /* Create */

         const formCreate = document.querySelector("#modal-create form");

         const createBtn = document.querySelector("#createBtn");

         createBtn.addEventListener('click', async event => {

            const formCreateData = new FormData(formCreate);

            const object = {};

            formCreateData.forEach((value, key) => {
               object[key] = value
            });
            if(request.body.id === undefined) {
               await fetch(`/dashboard/usuarios`, {
                  method: 'POST',
                  headers: { 
                     'Content-Type': 'application/json' 
                  },
                  body: JSON.stringify({
                     name: object.name,
                     email: object.email,
                     password: object.password
                  }),
               });
               window.location.reload();
            }
         });

         /* Update name and email */
         
         const formUpdate = document.querySelector("#modal-update form");

         [...document.querySelectorAll('.btn-info')].forEach(btn => {

            btn.addEventListener('click', event => {

               let tr = event.path.find(element => {

                  return (element.tagName.toUpperCase() === 'TR');
               });

               let data = JSON.parse(tr.dataset.row);

               for (let name in data) {

                  let input = formUpdate.querySelector(`[name=${name}]`);

                  switch (name) {

                  default:

                     if (input) input.value = data[name];
                  }
               }
               $('#modal-update').modal('show');
            });
         });

         const btnUpdateData = document.querySelector("#btnUpdateData");

         btnUpdateData.addEventListener('click', async event => {

            event.preventDefault();

            const formData = new FormData(formUpdate);

            const object = {};

            formData.forEach((value, key) => {
               object[key] = value
            });

            await fetch(`/dashboard/usuarios/${object.id}`, {
               method: 'PUT',
               headers: { 
                  'Content-Type': 'application/json' 
               },
               body: JSON.stringify({
                  id: object.id,
                  name: object.name,
                  email: object.email
               }),
            });
         });

         /* Update Password */

         const formUpdatePassword = document.querySelector("#modal-update-password form");

         [...document.querySelectorAll('.btn-update')].forEach(btn => {

            btn.addEventListener('click', event => {

               let tr = event.path.find(element => {

                  return (element.tagName.toUpperCase() === 'TR');
               });

               let data = JSON.parse(tr.dataset.row);

               for (let name in data) {

                  let input = formUpdatePassword.querySelector(`[name=${name}]`);

                  switch (name) {

                  default:

                     if (input) input.value = data[name];
                  }
               }
               $('#modal-update-password').modal('show');
            });
         });

         const btnUpdatePassword = document.querySelector("#btnUpdatePassword");

         btnUpdatePassword.addEventListener('click', async event => {

            event.preventDefault();

            const formDataPassword = new FormData(formUpdatePassword);

            const object = {};

            formDataPassword.forEach((value, key) => {
               object[key] = value
            });

            await fetch(`/dashboard/usuarios/${object.id}`, {
               method: 'PUT',
               headers: { 
                  'Content-Type': 'application/json' 
               },
               body: JSON.stringify({
                  id: object.id,
                  newPassword: object.newPassword,
                  passwordConfirm: object.passwordConfirm
               }),
            });
            window.location.reload();
         });

         /* Delete */

         [...document.querySelectorAll('.btn-delete')].forEach(btn => {

            btn.addEventListener('click', async event => {

               let tr = event.path.find(element => {

                  return (element.tagName.toUpperCase() === 'TR');
               });

               let data = JSON.parse(tr.dataset.row);

               if (confirm(`Deseja realmente excluir o usuário ${data.name}?`)) {

                  await fetch(`/dashboard/usuarios/${data.id}`, {
                     method: 'DELETE'
                  });
                  window.location.reload();
               }
            });
         });
      </script>
   </body>
</html>